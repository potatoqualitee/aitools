################################################################################
#
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•      â–ˆâ–ˆâ•‘
#   â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•      â•šâ•â•â•â•       â•šâ•â•
#
#                                    â†“â†“â†“
#
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#   â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•      â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•
#
#   PSConf.EU 2025 - Chrissy LeMaire (@funbucket.dev)
#   Converting 3500+ Pester Tests from v4 to v5 Using AI
#
################################################################################

################################################################################
#
#   Setup and Configuration
#
################################################################################

# Since it's coming from my repo and not the Gallery
Import-Module ./aitools.psd1 -Force

# Set default params and create reusable function
$PSDefaultParameterValues["Update-PesterTest:Raw"] = $true
$PSDefaultParameterValues["Import-Module:Verbose"] = $false
$PSDefaultParameterValues["Start-Process:NoNewWindow"] = $true

# Create function to clear changes
function Clear-Modified {
   Start-Process git -ArgumentList @("-C", "../dbatools", "restore", ".")
}

################################################################################
#
#   Check out the 3 integral prompt files
#
#   ğŸ“„ prompt.md
#   ğŸ“„ migration.md
#   ğŸ“„ style.md
#
#   Now let's see it in action..
#
################################################################################

# Show the BEFORE state - classic Pester v4
Start-Process code -ArgumentList ./prompts/prompt.md
Start-Process code -ArgumentList ./prompts/migration.md
Start-Process code -ArgumentList ./prompts/style.md


################################################################################
#
#   ğŸ§ª The actual test file
#
################################################################################

# Pick a medium-complexity test file
$testFile = "C:\github\dbatools\tests\Invoke-DbaDbShrink.Tests.ps1"

# Show the BEFORE state - classic Pester v4
Start-Process code -ArgumentList $testFile

################################################################################
#
#   ğŸš€ Migrate with Claude Code
#
#   First, check out the command and the tests that couldn't make the cut
#
################################################################################

# ğŸ“„ Load up public/Update-PesterTest.
Start-Process explorer -ArgumentList C:\github\aitools\public

# ğŸ“ Load up large files
Start-Process explorer -ArgumentList C:\github\dbatools\tests

################################################################################
#
#   ğŸ Now execute
#
################################################################################

# Set Claude Code just in case
Set-AIToolDefault -Tool Claude

# Clear all changes in the dbatools repo
Clear-Modified

# Run Claude
Update-PesterTest -InputObject $testFile

################################################################################
#
#   Claude excelled at
#
#   âœ… Structural refactoring (BeforeAll/AfterAll)
#   âœ… Parameter test refactoring
#   âœ… Where-Object conversions
#   âœ… Hashtable alignment
#   âœ… Comment preservation
#
#   Claude wasn't as good at
#
#   âŒ Large files
#   âŒ While rare, instructions were sometimes missed
#   âŒ Variable scoping fixes
#
#   "I would say [Claude migrated] about 80 percent automatically,
#   10 percent classic manual search and replace and 10 percent hard
#   manual work. Most manual cases were because code was not good in
#   the first place." ~ Andreas Jordan, co-migrator
#
#   Upgrading to v6
#
#   1. Update migration.md with v5 â†’ v6 changes
#   2. Update style.md if needed
#   3. Get-ChildItem *.Tests.ps1 | Update-PesterTest
#
################################################################################

################################################################################
#
#   âœ¨ Gemini
#
################################################################################

# Clear all changes in the dbatools repo
Clear-Modified

# Set Gemini for that free 1000
Set-AIToolDefault -Tool Gemini

# Run Gemini CLI
Get-ChildItem C:\github\dbatools\tests\*.Tests.ps1 |
   Update-PesterTest -First 1 -Skip 1 -Verbose

################################################################################
#
#   ğŸ§­ GitHub Copilot
#
################################################################################

# Requires subscription
Set-AIToolDefault -Tool Copilot

################################################################################
#
#   ğŸ§  First with GPT-5
#
################################################################################

# Clear all changes in the dbatools repo
Clear-Modified

# Update reasoning effort for ...different.. results
Set-AIToolConfig -Tool Codex -ReasoningEffort high

# Run
Get-ChildItem C:\github\dbatools\tests\*DbaDbShrink*.Tests.ps1 |
   Update-PesterTest -First 1 -Model gpt-5

################################################################################
#
#   ğŸ§  Now with Sonnet
#
################################################################################

# Clear all changes in the dbatools repo
Clear-Modified

Get-ChildItem C:\github\dbatools\tests\*DbaDbShrink*.Tests.ps1 |
   Update-PesterTest -First 1 -Model claude-sonnet-4.5

################################################################################
#
#   This is repeatable for other types of refactoring ğŸ‰
#
#   ğŸ§ª Test frameworks (Jest â†’ Vitest)
#   ğŸ”„ API upgrades (any v1 â†’ v2)
#   ğŸ¨ Linting/style fixes
#   ğŸ“ Documentation updates
#   ğŸŒ i18n sweeps
#   ğŸ§© Dependency migrations
#
################################################################################
